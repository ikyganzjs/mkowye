<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Donasi - IKY'S</title>

<style>
  body {
    margin: 0;
    font-family: "Poppins", sans-serif;
    background: linear-gradient(135deg, #0d0d0d, #1a1a1a);
    color: white;
  }

  .header {
    width: 100%;
    padding: 18px 0;
    text-align: center;
    font-size: 32px;
    font-weight: 700;
    background: rgba(255, 215, 0, 0.1);
    backdrop-filter: blur(8px);
    color: gold;
    letter-spacing: 1px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .wrapper {
    max-width: 900px;
    margin: 30px auto;
    padding: 20px;
    display: grid;
  grid-template-columns: 1fr;
    gap: 25px;
  }

  .card {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 16px;
    padding: 25px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    backdrop-filter: blur(10px);
    box-shadow: 0 0 30px rgba(255, 255, 255, 0.05);
  }

  .card-title {
    font-size: 26px;
    margin-bottom: 18px;
    font-weight: 600;
    color: gold;
  }

  input {
    width: 100%;
    padding: 14px;
    font-size: 18px;
    border-radius: 12px;
    border: none;
    margin-bottom: 20px;
    outline: none;
  }

  button {
    width: 100%;
    background: gold;
    color: black;
    font-size: 18px;
    padding: 12px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    transition: 0.3s;
  }

  button:hover {
    transform: scale(1.05);
    filter: brightness(1.15);
  }

  .qris-img {
    width: 260px;
    border-radius: 12px;
    margin-top: 15px;
  }

  .riwayat-item {
    background: rgba(255, 255, 255, 0.12);
    padding: 18px;
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(12px);
    box-shadow: 0 0 25px rgba(255, 255, 255, 0.08);
    margin-bottom: 14px;
    animation: slideUp 0.45s ease;
  }

  @keyframes slideUp {
    from { opacity: 0; transform: translateY(25px); }
    to { opacity: 1; transform: translateY(0); }
  }
@keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
#riwayatList {
    max-height: 260px;
    overflow-y: auto;
    padding-right: 6px;
    scroll-behavior: smooth;
  }

</style>
</head>
<body>

<!-- Loading Screen -->
<div id="loader" style="position:fixed; top:0; left:0; width:100%; height:100%; background:black; display:flex; justify-content:center; align-items:center; z-index:99999; flex-direction:column;">
  <div style="width:60px; height:60px; border:6px solid rgba(255,255,255,0.3); border-top-color:gold; border-radius:50%; animation:spin 1s linear infinite;"></div>
  <p style="margin-top:15px; color:gold; font-size:20px; font-weight:600;">Memuat...</p>
</div>

<style>
@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
</style>
  <div class="header">Donasi IKY'S</div>

  <div class="wrapper">

    <!-- Form Pembayaran -->
    <div class="card">
      <div class="card-title">Buat Pembayaran</div>

      <input type="number" id="nominal" placeholder="Masukkan Nominal (min 1.000)" />

      <button onclick="generateQRIS()">Buat QRIS</button>

      <div id="qrisBox" style="display:none; text-align:center; margin-top:20px;">
        <h3>ID Trx: <span id="trxId"></span></h3>
        <h4>Expired: <span id="expired"></span></h4>
        <h4>Biaya Admin: <span id="adminFee"></span></h4>
        <img id="qrisImg" class="qris-img" />
        <button style="margin-top:15px;" onclick="cekMutasi()">Cek Pembayaran</button>
      </div>
    </div>

    <!-- Riwayat -->
    <div class="card">
      <div class="card-title">Riwayat Pembayaran</div>
      <div id="riwayatList">Memuat...</div>
    </div>

  </div>

<script>
// Popup sukses mewah
function showPopup(message) {
  const popup = document.createElement('div');
  popup.style.position = 'fixed';
  popup.style.top = '20px';
  popup.style.right = '20px';
  popup.style.padding = '18px 25px';
  popup.style.background = 'rgba(0,0,0,0.7)';
  popup.style.border = '1px solid gold';
  popup.style.color = 'white';
  popup.style.borderRadius = '12px';
  popup.style.boxShadow = '0 0 15px gold';
  popup.style.fontSize = '17px';
  popup.style.zIndex = '9999';
  popup.style.animation = 'fadeIn 0.3s ease';
  popup.innerHTML = message;

  document.body.appendChild(popup);
  setTimeout(() => popup.remove(), 3500);
}

// Load riwayat awal & auto refresh
async function loadRiwayatAwal() {
  let url = `${BASE}/mutasiqr?apikey=${KEY}&username=${USER}&token=${TOKEN}`;
  let BASE = process.env.API_BASE;
  let KEY = process.env.API_KEY;
  let USER = process.env.API_USERNAME;
  let TOKEN = encodeURIComponent(process.env.API_TOKEN);
  let res = await fetch(url);
  let data = await res.json();

  let list = document.getElementById("riwayatList");
  list.innerHTML = "";

  if (!data.status || data.result.length === 0) {
    list.innerHTML = "Belum ada transaksi";
    return;
  }

  data.result.forEach((item) => {
    list.innerHTML += `
      <div class='riwayat-item'>
        <div><b>Tanggal:</b> ${item.tanggal}</div>
        <div><b>Brand:</b> ${item.brand.name}</div>
        <button onclick="downloadBukti('${item.tanggal}','${item.brand.name}')" style="margin-top:10px; padding:8px 12px; border:none; background:gold; color:black; border-radius:8px; cursor:pointer;">Download Bukti</button>
      </div>`;
  });
}

// Auto refresh setiap 5 detik
setInterval(loadRiwayatAwal, 5000);

loadRiwayatAwal();

// Hilangkan loader setelah semuanya siap
window.addEventListener('load', () => {
  setTimeout(() => {
    document.getElementById('loader').style.opacity = '0';
    document.getElementById('loader').style.transition = '0.5s';
    setTimeout(() => document.getElementById('loader').remove(), 600);
  }, 600);
});

async function generateQRIS() {
  let nominal = document.getElementById("nominal").value;
  if (nominal < 1000) return alert("Minimal 1.000");

  let admin = Math.floor(Math.random() * 20) + 88; // biaya admin 300 - 1000(Math.random() * 500) + 500; // 500 - 1000
  let total = parseInt(nominal) + admin;

  let url = `${BASE}/createpayment?apikey=${KEY}&username=${USER}&token=${TOKEN}`;
  
  let BASE = process.env.API_BASE;
  let KEY = process.env.API_KEY;
  let USER = process.env.API_USERNAME;
  let TOKEN = encodeURIComponent(process.env.API_TOKEN);
  let res = await fetch(url);
  let data = await res.json();

  if (!data.status) return alert("Gagal membuat QRIS");

  let result = data.result;

  document.getElementById("trxId").innerText = result.idtransaksi;
  document.getElementById("expired").innerText = result.expired;
  document.getElementById("qrisImg").src = result.imageqris.url;
  document.getElementById("adminFee").innerText = admin;

  document.getElementById("qrisBox").style.display = "block";
  showPopup("QRIS berhasil dibuat ✔️");
}

async function cekMutasi() {
  loadRiwayatAwal();
  document.getElementById("qrisBox").style.display = "none";
  showPopup("Mutasi berhasil diperbarui ✔️");
}

// Download bukti transaksi
function downloadBukti(tanggal, brand) {
  let text = `Bukti Transaksi
Tanggal: ${tanggal}
Brand: ${brand}`;
  let blob = new Blob([text], { type: 'text/plain' });
  let link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `bukti-transaksi-${tanggal}.txt`;
  link.click();
  showPopup("Bukti transaksi berhasil diunduh ✔️");
}
</script>
</body>
</html>